{% extends "base.html" %}
{% load django_tables2 %}
{% load humanize %}

{% block content %}
<section class="section">
    <div class="section-header">
        <h1>{{ judul }}</h1>
    </div>

    <!-- UPLOAD FORM -->
    <div class="row">
        <div class="col-lg-12 col-md-12 col-12 col-sm-12">
            <div class="card">
                <div class="card-header">
                    <h4>{{ judul }}</h4>
                </div>
                <div class="card-body col-12 col-md-10 mx-auto">
                    <form id="uploadForm" method="post" enctype="multipart/form-data">
                        <div class="modal-header">
                            <h5 class="modal-title">{{ judul }}</h5>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                {% csrf_token %}
                                {{ form.as_p }}
                            </div>
                        </div>
                        {% if form.non_field_errors %}
                        <div class="text-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}
                        <div class="modal-footer">
                            {% comment %} <a href="{{link_url}}" class="btn btn-warning ml-2">Batal</a> {% endcomment %}
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </div>
                    </form>
                    <div class="progress mt-2" style="height:25px; display:none;" id="progressWrapper">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width:0%" id="progressBar">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PROGRESS BAR -->
    <div class="row mt-2">
        <div class="col-lg-12">
            <div class="progress mb-3" style="height: 25px; display:none;" id="progressWrapper">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar"
                     style="width:0%"
                     id="progressBar">
                    0%
                </div>
            </div>
        </div>
    </div>

    <!-- TABEL SIPD -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4>Data SIPD Tahun {{tahun}}</h4>
                </div>
                <div class="card-body col-12 col-md-12 mx-auto">
                    <form method="get" class="mb-3">
                        <div class="row align-items-end g-2">

                            <!-- SEARCH -->
                            <div class="col-md-6">
                                <label class="form-label mb-1">Cari</label>
                                <div class="position-relative">
                                    <input type="text"
                                           name="q"
                                           id="searchInput"
                                           class="form-control pe-5"
                                           placeholder="Cari data SIPD..."
                                           value="{{ request.GET.q }}"
                                           hx-get="{% url 'upload_sipd' %}"
                                           hx-trigger="keyup changed delay:400ms"
                                           hx-target="#table-wrapper"
                                           hx-push-url="true"
                                    >
                                    <button type="button"
                                            id="clearSearch"
                                            class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2 p-0"
                                            style="display:none; z-index:5">
                                        <i class="fa fa-times text-muted"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- PER PAGE -->
                            <div class="col-md-3 col-sm-6">
                                <div class="position-relative">
                                    <label class="form-label mb-1">Baris</label>
                                    <select name="per_page"
                                            class="form-control pe-5"
                                            hx-get="{% url 'upload_sipd' %}"
                                            hx-trigger="change"
                                            hx-target="#table-wrapper"
                                            hx-push-url="true"
                                            hx-include="[name='q']"
                                    >
                                        <option value="10" {% if request.GET.per_page == "10" %}selected{% endif %}>10</option>
                                        <option value="25" {% if request.GET.per_page == "25" %}selected{% endif %}>25</option>
                                        <option value="50" {% if request.GET.per_page == "50" %}selected{% endif %}>50</option>
                                        <option value="all" {% if request.GET.per_page == "all" %}selected{% endif %}>Semua</option>
                                    </select>
                                </div>
                            </div>

                            <!-- EXPORT -->
                            <div class="col-md-3 text-md-end">
                                <a href="{% url 'export_sipd_excel' %}?{{ request.GET.urlencode }}"
                                   class="btn btn-success w-100 w-md-auto">
                                    <i class="fa fa-file-excel me-1"></i> Export Excel
                                </a>
                            </div>

                        </div>
                    </form>

                    <!-- TABLE WRAPPER -->
                    <div id="table-wrapper" hx-indicator="#btnSpinner">
                        {% include "sipd/partials/table.html" %}
                    </div>

                    <!-- SKIPPED ROWS -->
                    <div id="skippedRows" hx-get="{% url 'sipd-skipped' tahun %}" hx-trigger="load" hx-swap="innerHTML">
                    </div>

                </div>
            </div>
        </div>
    </div>

</section>
{% endblock content %}

{% block style %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.7/css/dataTables.bootstrap5.css" />
<style>
input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; }
input[type="search"]::-ms-clear { display: none; }
</style>
{% endblock style %}

{% block src %}
<script src="https://cdn.datatables.net/2.0.7/js/dataTables.bootstrap5.js"></script>
{% endblock src %}

{% block javascript %}
<script>
$(document).ready(function() {
    // Refresh tabel HTMX setelah upload selesai
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if(evt.detail.xhr.status === 200) location.reload();
    });

    {% if messages %}
    {% for message in messages %}
        iziToast.{{ message.tags }}({
            title: '{{ message.tags }}',
            message: '{{ message }}',
            position: 'topRight'
        });
    {% endfor %}
    {% endif %}
});

// SEARCH CLEAR BUTTON
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("searchInput");
    const clearBtn = document.getElementById("clearSearch");

    function toggleClear() {
        clearBtn.style.display = input.value ? "block" : "none";
    }

    input.addEventListener("input", toggleClear);
    clearBtn.addEventListener("click", function () {
        input.value = "";
        toggleClear();
        input.dispatchEvent(new Event("change"));
        input.focus();
    });

    toggleClear();
});

// UPLOAD FORM + PROGRESS BAR
document.getElementById("uploadForm").addEventListener("submit", function(e){
    e.preventDefault();
    const formData = new FormData(this);
    const progressWrapper = document.getElementById("progressWrapper");
    const progressBar = document.getElementById("progressBar");
    progressWrapper.style.display = "block";

    fetch("{% url 'upload_sipd' %}", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
        const taskId = data.task_id;

        // polling progress via HTMX/JSON
        const interval = setInterval(() => {
            fetch(`/sipd/progress/${taskId}/`)
            .then(res => res.json())
            .then(p => {
                if(!p.current || !p.total) return;
                let percent = Math.round((p.current / p.total) * 100);
                progressBar.style.width = percent + "%";
                progressBar.innerText = percent + "%";
                if(percent >= 100) {
                    clearInterval(interval);
                    progressBar.classList.remove("progress-bar-animated");
                    progressBar.classList.add("bg-success");
                }
            });
        }, 1000);
    });
});
<script>
document.getElementById("uploadForm").addEventListener("submit", function(e){
    e.preventDefault();
    const formData = new FormData(this);
    const progressWrapper = document.getElementById("progressWrapper");
    const progressBar = document.getElementById("progressBar");

    progressWrapper.style.display = "block";
    progressBar.style.width = "0%";
    progressBar.innerText = "0%";

    fetch("{% url 'upload_sipd' %}", { method:"POST", body:formData })
    .then(res => res.json())
    .then(data => {
        if(data.error){
            alert("Error: "+JSON.stringify(data.error));
            return;
        }

        const tahun = {{ tahun }};
        const interval = setInterval(() => {
            fetch(`/sipd/progress/${tahun}/`)
            .then(res => res.json())
            .then(p => {
                if(p.done){
                    progressBar.style.width = "100%";
                    progressBar.innerText = "100%";
                    progressBar.classList.remove("progress-bar-animated");
                    progressBar.classList.add("bg-success");
                    clearInterval(interval);
                    location.reload();
                    return;
                }
                if(p.current && p.total){
                    let percent = Math.round((p.current / p.total) * 100);
                    progressBar.style.width = percent + "%";
                    progressBar.innerText = percent + "%";
                }
            });
        }, 1000);
    });
});
</script>
{% endblock javascript %}
